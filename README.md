# Safety-Hanta: ì‚°ì—… ì•ˆì „ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ

ì´ í”„ë¡œì íŠ¸ëŠ” ì‚°ì—… í˜„ìž¥ì˜ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ìœ„í—˜ ìš”ì†Œë¥¼ ê°ì§€í•˜ëŠ” AI ì‹œìŠ¤í…œìž…ë‹ˆë‹¤. Qwen3-VL ë©€í‹°ëª¨ë‹¬ ëª¨ë¸ì„ í™œìš©í•˜ë©°, Kubernetes ê¸°ë°˜ì˜ í™•ìž¥ ê°€ëŠ¥í•œ ì•„í‚¤í…ì²˜ë¡œ êµ¬ì„±ë˜ì–´ ìžˆìŠµë‹ˆë‹¤.

## ðŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ (Kubernetes)

ë³¸ ì‹œìŠ¤í…œì€ Kubernetes ìƒì—ì„œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í˜•íƒœë¡œ ë™ìž‘í•˜ë©°, ê° ì»´í¬ë„ŒíŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### 1. Node êµ¬ì„±
*   **Control Plane**: í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ ë° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ë‹´ë‹¹.
*   **Worker Node (GPU)**: ê³ ì„±ëŠ¥ ì—°ì‚°ì´ í•„ìš”í•œ AI ì¶”ë¡ (`inference`) íŒŒë“œê°€ ë°°ì¹˜ë˜ëŠ” ë…¸ë“œ. NVIDIA GPUê°€ í• ë‹¹ë©ë‹ˆë‹¤.
*   **Worker Node (General)**: ë°ì´í„° ìˆ˜ì§‘(`capture`) ë° ë©”ì‹œì§€ í(`redis`) ë“± I/O ì¤‘ì‹¬ì˜ íŒŒë“œê°€ ë°°ì¹˜ë©ë‹ˆë‹¤.

### 2. Pod ì—­í• 
*   **ðŸŽ¥ rtsp-sim (Simulator)**
    *   CCTV ì—­í• ì„ í•˜ëŠ” ê°€ìƒ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ìƒì„±í•˜ì—¬ ì†¡ì¶œí•©ë‹ˆë‹¤.
    *   ë‹¤ì–‘í•œ ì‚°ì—… í˜„ìž¥ ì‹œë‚˜ë¦¬ì˜¤ ì˜ìƒì„ RTSP í”„ë¡œí† ì½œë¡œ ì œê³µí•©ë‹ˆë‹¤.
*   **ðŸ“¥ capture-worker**
    *   RTSP ìŠ¤íŠ¸ë¦¼ì„ ë°›ì•„ ë¹„ë””ì˜¤ íŒŒì¼ë¡œ ì €ìž¥(Capture)í•©ë‹ˆë‹¤.
    *   ì €ìž¥ëœ íŒŒì¼ì˜ ê²½ë¡œì™€ ë©”íƒ€ë°ì´í„°ë¥¼ Redis íì— ì ìž¬í•©ë‹ˆë‹¤.
*   **ðŸ§  inference (VLLM)**
    *   í•µì‹¬ AI ì—”ì§„ìž…ë‹ˆë‹¤. Redisì—ì„œ ìž‘ì—… ìš”ì²­ì„ ê°€ì ¸ì™€ Qwen3-VL ëª¨ë¸ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.
    *   "ì•ˆì „", "ìœ„í—˜", "ê²½ê³ " ë“±ì˜ ìƒíƒœë¥¼ íŒë‹¨í•˜ê³  êµ¬ì²´ì ì¸ ìœ„í—˜ ìš”ì†Œë¥¼ ë¦¬í¬íŒ…í•©ë‹ˆë‹¤.
*   **ðŸ“¨ redis**
    *   `capture-worker`ì™€ `inference` ì‚¬ì´ì˜ ë²„í¼ ì—­í• ì„ í•˜ëŠ” ë©”ì‹œì§€ ë¸Œë¡œì»¤ìž…ë‹ˆë‹¤.
    *   ìž‘ì—… ëŒ€ê¸°ì—´(Queue)ì„ ê´€ë¦¬í•˜ì—¬ ì‹œìŠ¤í…œ ë¶€í•˜ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤.

---

## âš¡ í•µì‹¬ ìµœì í™” ê¸°ìˆ  (Methodologies)

ê³ ì„±ëŠ¥ ì‹¤ì‹œê°„ ì²˜ë¦¬ë¥¼ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ìˆ ì  ë°©ë²•ë¡ ë“¤ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.

### 1. Prefix Caching (VLLM)
*   **ë¬¸ì œ**: Few-shot í”„ë¡¬í”„íŒ…(ì˜ˆì‹œë¥¼ ì—¬ëŸ¬ ê°œ ë³´ì—¬ì£¼ëŠ” ë°©ì‹)ì€ í”„ë¡¬í”„íŠ¸ ê¸¸ì´ê°€ ê¸¸ì–´ì ¸ ì—°ì‚° ë¹„ìš©ì´ ë†’ìŠµë‹ˆë‹¤.
*   **í•´ê²°**: **Prefix Caching**ì„ ë„ìž…í•˜ì—¬, ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì™€ ê³ ì •ëœ Few-shot ë¹„ë””ì˜¤ ì˜ˆì‹œë“¤ì— ëŒ€í•œ KV Cacheë¥¼ ë©”ëª¨ë¦¬ì— ìƒì£¼ì‹­ë‹ˆë‹¤.
*   **íš¨ê³¼**: ë§¤ ìš”ì²­ë§ˆë‹¤ ë°˜ë³µë˜ëŠ” ì•žë¶€ë¶„(Prefix)ì˜ ì—°ì‚°ì„ ê±´ë„ˆë›°ê³ , ìƒˆë¡œìš´ ìž…ë ¥(Query)ë§Œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì¶”ë¡  ì†ë„ê°€ ë¹„ì•½ì ìœ¼ë¡œ í–¥ìƒë©ë‹ˆë‹¤.

### 2. Threading & Pipeline (Async I/O)
*   **ë¬¸ì œ**: ë¹„ë””ì˜¤ ë””ì½”ë”©ê³¼ ì „ì²˜ë¦¬(Pre-processing)ëŠ” CPUë¥¼, AI ì¶”ë¡ ì€ GPUë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ë©´ GPUê°€ CPU ìž‘ì—…ì„ ê¸°ë‹¤ë¦¬ëŠ” ìœ íœ´ ì‹œê°„(Idle)ì´ ë°œìƒí•©ë‹ˆë‹¤.
*   **í•´ê²°**: `inference` ì„œë¹„ìŠ¤ ë‚´ì—ì„œ **Threading**ì„ ì‚¬ìš©í•˜ì—¬ ìƒì‚°ìž(Preparer)-ì†Œë¹„ìž(Main Loop) íŒ¨í„´ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
    *   `Preparer Thread`: CPUë¡œ ë¹„ë””ì˜¤ë¥¼ ì½ê³  í…ì„œë¡œ ë³€í™˜í•˜ì—¬ íì— ìŒ“ìŠµë‹ˆë‹¤.
    *   `Main Loop`: GPUë¡œ ì¤€ë¹„ëœ ë°°ì¹˜ë¥¼ ê°€ì ¸ì™€ ì¦‰ì‹œ ì¶”ë¡ í•©ë‹ˆë‹¤.
*   **íš¨ê³¼**: CPUì™€ GPUê°€ ë³‘ë ¬ë¡œ ë™ìž‘í•˜ì—¬ GPU ê°€ë™ë¥ (Utilization)ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.

### 3. Zero-Copy (Reference Passing via Shared Volume)
*   **ë¬¸ì œ**: ê³ í•´ìƒë„ ë¹„ë””ì˜¤ ë°ì´í„°ë¥¼ Redisë¥¼ í†µí•´ ë°”ì´íŠ¸(Byte) ë‹¨ìœ„ë¡œ ì „ì†¡í•˜ë©´ ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œì™€ ì§ë ¬í™”/ì—­ì§ë ¬í™” ë¹„ìš©ì´ ë§¤ìš° í½ë‹ˆë‹¤.
*   **í•´ê²°**: **Shared Volume** ì „ëžµì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    *   `capture-worker`ëŠ” ê³µìœ  ë³¼ë¥¨ì— íŒŒì¼ì„ ì“°ê³ , Redisì—ëŠ” ì˜¤ì§ **íŒŒì¼ ê²½ë¡œ(String Path)**ë§Œ ë³´ëƒ…ë‹ˆë‹¤.
    *   `inference`ëŠ” í•´ë‹¹ ê²½ë¡œì—ì„œ íŒŒì¼ì„ ì§ì ‘ ì½ìŠµë‹ˆë‹¤(Read-only).
*   **íš¨ê³¼**: ë¶ˆí•„ìš”í•œ ë©”ëª¨ë¦¬ ë³µì‚¬ë¥¼ ë°©ì§€(Zero-copy)í•˜ê³  ì‹œìŠ¤í…œ ì „ì²´ ëŒ€ì—­í­ì„ ì ˆì•½í•©ë‹ˆë‹¤.

---

## âš™ï¸ ì„¤ì • ê°€ì´ë“œ (Configuration)

### ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ê°œìˆ˜ í™•ìž¥ (Scaling)
ì‹œìŠ¤í…œì˜ ì¹´ë©”ë¼ ì±„ë„ ìˆ˜ë¥¼ ê¸°ë³¸ 10ê°œì—ì„œ Nê°œë¡œ í™•ìž¥í•˜ê±°ë‚˜ ì¶•ì†Œí•˜ë ¤ë©´ ë‹¤ìŒ ë‘ ê°€ì§€ ì„¤ì •ì„ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.

1.  **ì‹œë®¬ë ˆì´í„° ì±„ë„ ìˆ˜ ë³€ê²½** (`k8s/02-rtsp-sim.yaml`)
    *   `simulator` ì»¨í…Œì´ë„ˆì˜ `NUM_STREAMS` í™˜ê²½ ë³€ìˆ˜ë¥¼ ì›í•˜ëŠ” ìˆ«ìžë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.
    ```yaml
    - name: NUM_STREAMS
      value: "20"  # ì˜ˆ: 20ê°œ ì±„ë„ ìƒì„±
    ```

2.  **ìº¡ì²˜ ì›Œì»¤ íŒŒë“œ ìˆ˜ ë³€ê²½** (`k8s/03-capture-worker-deployment.yaml`)
    *   `replicas` ê°œìˆ˜ë¥¼ `NUM_STREAMS`ì™€ ë™ì¼í•˜ê²Œ ë§žì¶¥ë‹ˆë‹¤.
    *   ê° íŒŒë“œëŠ” ìžë™ìœ¼ë¡œ ìžì‹ ì˜ ì¸ë±ìŠ¤ì— ë§žëŠ” ì¹´ë©”ë¼(`cam{N}`)ì— ì—°ê²°í•©ë‹ˆë‹¤.
    ```yaml
    replicas: 20  # íŒŒë“œ 20ê°œ ìƒì„± (worker-0 -> cam1 ... worker-19 -> cam20)
    ```