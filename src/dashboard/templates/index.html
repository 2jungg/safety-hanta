
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Hanta Dashboard</title>
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="glass p-4 flex justify-between items-center z-10">
        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-400">
            üõ°Ô∏è Safety Hanta Monitor
        </h1>
        <div class="text-sm text-gray-400" id="clock">--:--:--</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar: Cameras -->
        <aside class="w-64 glass m-4 rounded-xl p-4 flex flex-col space-y-4">
            <h2 class="text-lg font-semibold text-gray-300">Cameras</h2>
            <div id="camera-list" class="space-y-2">
                <!-- Camera Items Injected Here -->
                <div class="p-3 rounded bg-slate-800 flex items-center justify-between cursor-pointer hover:bg-slate-700 transition">
                    <span>Server Room</span>
                    <span class="w-3 h-3 rounded-full bg-green-500 shadow-lg shadow-green-500/50"></span>
                </div>
            </div>
        </aside>

        <!-- Main Content: Video Player -->
        <main class="flex-1 m-4 ml-0 rounded-xl glass flex flex-col items-center justify-center p-6 relative">
            <div class="w-full max-w-4xl aspect-video bg-black rounded-lg overflow-hidden shadow-2xl relative">
                <video id="main-player" controls autoplay loop class="w-full h-full object-contain">
                    <source src="" type="video/mp4">
                    Select an event to view footage.
                </video>
                <div class="absolute top-4 left-4 bg-red-600 text-white px-3 py-1 rounded font-bold hidden" id="live-badge">
                    ACCIDENT CLIP
                </div>
            </div>
            <div class="mt-4 text-left w-full max-w-4xl">
                <h2 id="video-title" class="text-2xl font-bold text-white">Select an event</h2>
                <p id="video-desc" class="text-gray-400 mt-1">...</p>
            </div>
        </main>

        <!-- Right Panel: Activity Feed -->
        <aside class="w-96 glass m-4 ml-0 rounded-xl p-4 flex flex-col">
            <h2 class="text-lg font-semibold text-gray-300 mb-4">Safety Timeline</h2>
            <div id="event-feed" class="flex-1 overflow-y-auto space-y-3 scrollbar-hide pr-2">
                <!-- Events Injected Here -->
            </div>
        </aside>
    </div>

    <script>
        // Update Clock
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

        const cameraList = document.getElementById('camera-list');
        const eventFeed = document.getElementById('event-feed');
        const mainPlayer = document.getElementById('main-player');
        
        let knownEvents = new Set();
        let cameras = new Set();

        async function fetchEvents() {
            try {
                const res = await fetch('/api/events');
                const events = await res.json();
                
                // Process Events
                // Events are ordered newest first (since lpush/lrange 0-N)
                
                eventFeed.innerHTML = '';
                
                events.forEach((evt, index) => {
                    // Add Camera if new
                    if (!cameras.has(evt.stream_id)) {
                        cameras.add(evt.stream_id);
                        renderCameras();
                    }
                    
                    // Create Card
                    const card = document.createElement('div');
                    card.className = `p-4 rounded-lg cursor-pointer transition border border-l-4 ${
                        evt.level === 'DANGER' || evt.level === 'EXTREME' 
                        ? 'bg-red-900/20 border-red-500 hover:bg-red-900/40' 
                        : 'bg-yellow-900/20 border-yellow-500 hover:bg-yellow-900/40'
                    }`;
                    
                    const timeStr = new Date(evt.timestamp * 1000).toLocaleTimeString();
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <span class="font-bold ${evt.level === 'DANGER' ? 'text-red-400' : 'text-yellow-400'}">${evt.level}</span>
                            <span class="text-xs text-gray-400">${timeStr}</span>
                        </div>
                        <div class="mt-1 font-medium text-sm text-gray-200">${evt.stream_id}</div>
                        <div class="text-xs text-gray-400 mt-1 line-clamp-2">${evt.description}</div>
                    `;
                    
                    card.onclick = () => playVideo(evt);
                    eventFeed.appendChild(card);
                    
                    // Auto-play newest danger if not manually playing?
                    // For now simple click.
                });

            } catch (e) {
                console.error("Fetch error", e);
            }
        }

        function renderCameras() {
            cameraList.innerHTML = '';
            cameras.forEach(cam => {
                const el = document.createElement('div');
                el.className = 'p-3 rounded bg-slate-800/50 flex items-center justify-between';
                el.innerHTML = `
                    <span class="text-sm font-medium">${cam}</span>
                    <span class="w-2.5 h-2.5 rounded-full bg-green-500 shadow shadow-green-500/50"></span>
                `;
                cameraList.appendChild(el);
            });
        }

        function playVideo(evt) {
            // Video path: /videos/accident_clips/filename.mp4
            // Our API: /video/filename
            const filename = evt.video_clip.split('/').pop();
            const url = `/video/${filename}`;
            
            mainPlayer.src = url;
            mainPlayer.play();
            
            document.getElementById('video-title').innerText = `${evt.level}: ${evt.stream_id}`;
            document.getElementById('video-desc').innerText = `${new Date(evt.timestamp * 1000).toLocaleString()} - ${evt.description}`;
            document.getElementById('live-badge').classList.remove('hidden');
        }

        // Poll every 3 seconds
        fetchEvents();
        setInterval(fetchEvents, 3000);
    </script>
</body>
</html>
