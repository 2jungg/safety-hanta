# Use the official vLLM container (much smaller than Triton)
FROM vllm/vllm-openai:latest

# Set environment variables for non-interactive installation
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Install build dependencies for vllm and torchcodec
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    cmake \
    pkg-config \
    pybind11-dev \
    libavcodec-dev \
    libavformat-dev \
    libavutil-dev \
    libswscale-dev \
    libavdevice-dev \
    libavdevice-dev \
    libavfilter-dev \
    && \
    rm -rf /var/lib/apt/lists/*

# Install uv for package management
RUN pip install --break-system-packages uv

# Create a working directory
WORKDIR /app

# Copy only necessary directories and files
COPY pyproject.toml .
COPY configs ./configs
COPY prompts ./prompts
COPY cosmos_reason1_utils ./cosmos_reason1_utils


# Step 1: Install base PyPI dependencies
RUN uv pip install --break-system-packages \
  --system \
  "accelerate>=1.10.1" \
  "pyyaml>=6.0.2" \
  "qwen-vl-utils>=0.0.14" \
  "rich" \
  "transformers>=4.57.0" \
  "redis" \
  "opencv-python" \
  "torchcodec"

# Step 2: Install the local editable package
RUN uv pip install --break-system-packages --system -e ./cosmos_reason1_utils

